УзелНастроек = ПланыОбмена.усОбменУправлениеСкладом.ЭтотУзел();
	
	СвойствоАкция            = УзелНастроек.СвойствоАкция_Номенклаутра;
	СвойствоСтатуса          = УзелНастроек.СвойствоСтатус_ЗаданиеНаПеревозку;
	ЗначениеСвойствоСтатуса	 = УзелНастроек.Значеине_СвойствоСтатус_Обработан_ЗаданиеНаПеревозку; 
	ЗначениеСвойствоВыгружен = УзелНастроек.Значеине_СвойствоСтатус_Выгружено_ЗаданиеНаПеревозку;
    
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ИДДок.Идентификатор КАК ID,
	|	ЗаданиеНаПеревозку.Дата КАК Date,
	|	ЗаданиеНаПеревозку.Номер КАК Number,
	|	""ОтгрузкаНаСклад"" КАК ShipmentDirection,
	|	ЗаданиеНаПеревозку.Комментарий КАК Description,
	|	ЗаданиеНаПеревозку.Ссылка,
	|	ЗаданиеНаПеревозку.ДатаВремяРейсаПланС КАК PlanTime,
	|	ИДТранспорт.Идентификатор КАК Transport,
	|	ИДВодитель.Идентификатор КАК Driver,
	|	ВЫБОР
	|		КОГДА ЗаданиеНаПеревозкуДополнительныеРеквизиты.Значение = &ЗначениеСвойствоСтатуса
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗначениеСвойстваОбработан,
	|	ЗаданиеНаПеревозкуДополнительныеРеквизиты.Значение
	|ПОМЕСТИТЬ втДокументы
	|ИЗ
	|	Документ.ЗаданиеНаПеревозку КАК ЗаданиеНаПеревозку
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДДок
	|		ПО ЗаданиеНаПеревозку.Ссылка = ИДДок.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДТранспорт
	|		ПО ЗаданиеНаПеревозку.ТранспортноеСредство = ИДТранспорт.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДВодитель
	|		ПО ЗаданиеНаПеревозку.Водитель = ИДВодитель.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаданиеНаПеревозку.ДополнительныеРеквизиты КАК ЗаданиеНаПеревозкуДополнительныеРеквизиты
	|		ПО ЗаданиеНаПеревозку.Ссылка = ЗаданиеНаПеревозкуДополнительныеРеквизиты.Ссылка
	|			И (ЗаданиеНаПеревозкуДополнительныеРеквизиты.Свойство = &СвойствоСтатуса)
	|ГДЕ
	|	ЗаданиеНаПеревозку.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокументы.ID,
	|	втДокументы.Date,
	|	втДокументы.Number,
	|	втДокументы.ShipmentDirection,
	|	втДокументы.Description,
	|	втДокументы.Ссылка,
	|	втДокументы.PlanTime,
	|	втДокументы.Transport,
	|	втДокументы.Driver,
	|	втДокументы.ЗначениеСвойстваОбработан КАК Корректировка,
	|	втДокументы.Значение
	|ИЗ
	|	втДокументы КАК втДокументы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаданиеНаПеревозкуРаспоряжения.Ссылка,
	|	ЗаданиеНаПеревозкуРаспоряжения.Распоряжение,
	|	ЕСТЬNULL(упИдентификаторыОбмена.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК IDOrder,
	|	ЗаданиеНаПеревозкуРаспоряжения.НомерСтроки
	|ПОМЕСТИТЬ втДокДляПеревозки
	|ИЗ
	|	Документ.ЗаданиеНаПеревозку.Распоряжения КАК ЗаданиеНаПеревозкуРаспоряжения
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК упИдентификаторыОбмена
	|		ПО ЗаданиеНаПеревозкуРаспоряжения.Распоряжение = упИдентификаторыОбмена.Объект
	|ГДЕ
	|	ЗаданиеНаПеревозкуРаспоряжения.Ссылка В
	|			(ВЫБРАТЬ
	|				втДокументы.Ссылка
	|			ИЗ
	|				втДокументы КАК втДокументы)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокДляПеревозки.Ссылка,
	|	втДокДляПеревозки.Распоряжение,
	|	втДокДляПеревозки.IDOrder,
	|	втДокДляПеревозки.НомерСтроки КАК LineNumber
	|ИЗ
	|	втДокДляПеревозки КАК втДокДляПеревозки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииРасхождения.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА НоменклатураДополнительныеРеквизиты.Значение
	|		ИНАЧЕ КорректировкаРеализацииРасхождения.Номенклатура
	|	КОНЕЦ КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииРасхождения.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА ВЫРАЗИТЬ(НоменклатураДополнительныеРеквизиты.Значение КАК Справочник.Номенклатура).ЕдиницаИзмерения
	|		ИНАЧЕ КорректировкаРеализацииРасхождения.Упаковка
	|	КОНЕЦ КАК Упаковка,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииРасхождения.КоличествоУпаковок > 0
	|			ТОГДА КорректировкаРеализацииРасхождения.КоличествоУпаковок
	|		ИНАЧЕ -КорректировкаРеализацииРасхождения.КоличествоУпаковок
	|	КОНЕЦ КАК КоличествоУпаковок,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииРасхождения.Количество > 0
	|			ТОГДА КорректировкаРеализацииРасхождения.Количество
	|		ИНАЧЕ -КорректировкаРеализацииРасхождения.Количество
	|	КОНЕЦ КАК Количество,
	|	КорректировкаРеализацииРасхождения.НомерСтроки
	|ПОМЕСТИТЬ втКорректмровки
	|ИЗ
	|	Документ.КорректировкаРеализации.Расхождения КАК КорректировкаРеализацииРасхождения
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|		ПО КорректировкаРеализацииРасхождения.Номенклатура = НоменклатураДополнительныеРеквизиты.Ссылка
	|			И (НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоАкция)
	|ГДЕ
	|	ВЫРАЗИТЬ(КорректировкаРеализацииРасхождения.Ссылка.ДокументОснование КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента В
	|			(ВЫБРАТЬ
	|				втДокДляПеревозки.Распоряжение
	|			ИЗ
	|				втДокДляПеревозки КАК втДокДляПеревозки)
	|	И КорректировкаРеализацииРасхождения.Ссылка.Проведен
	|	И ИСТИНА В
	|			(ВЫБРАТЬ
	|				втДокументы.ЗначениеСвойстваОбработан
	|			ИЗ
	|				втДокументы КАК втДокументы)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтКлиентаТовары.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА НоменклатураДополнительныеРеквизиты.Значение
	|		ИНАЧЕ ВозвратТоваровОтКлиентаТовары.Номенклатура
	|	КОНЕЦ КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтКлиентаТовары.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА ВЫРАЗИТЬ(НоменклатураДополнительныеРеквизиты.Значение КАК Справочник.Номенклатура).ЕдиницаИзмерения
	|		ИНАЧЕ ВозвратТоваровОтКлиентаТовары.Упаковка
	|	КОНЕЦ КАК Упаковка,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтКлиентаТовары.КоличествоУпаковок > 0
	|			ТОГДА ВозвратТоваровОтКлиентаТовары.КоличествоУпаковок
	|		ИНАЧЕ -ВозвратТоваровОтКлиентаТовары.КоличествоУпаковок
	|	КОНЕЦ КАК КоличествоУпаковок,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтКлиентаТовары.Количество > 0
	|			ТОГДА ВозвратТоваровОтКлиентаТовары.Количество
	|		ИНАЧЕ -ВозвратТоваровОтКлиентаТовары.Количество
	|	КОНЕЦ КАК Количество,
	|	ВозвратТоваровОтКлиентаТовары.НомерСтроки
	|ПОМЕСТИТЬ втВозврат
	|ИЗ
	|	Документ.ВозвратТоваровОтКлиента.Товары КАК ВозвратТоваровОтКлиентаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|		ПО ВозвратТоваровОтКлиентаТовары.Номенклатура = НоменклатураДополнительныеРеквизиты.Ссылка
	|			И (НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоАкция)
	|ГДЕ
	|	ВозвратТоваровОтКлиентаТовары.Ссылка.Проведен
	|	И ИСТИНА В
	|			(ВЫБРАТЬ
	|				втДокументы.ЗначениеСвойстваОбработан
	|			ИЗ
	|				втДокументы КАК втДокументы)
	|	И ВЫРАЗИТЬ(ВозвратТоваровОтКлиентаТовары.Ссылка.ДокументРеализации КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента В
	|			(ВЫБРАТЬ
	|				втДокДляПеревозки.Распоряжение
	|			ИЗ
	|				втДокДляПеревозки КАК втДокДляПеревозки)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ИДНомен.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК NomenclatureID,
	|	ЕСТЬNULL(ИДУпаковки.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК Upak,
	|	втКорректмровки.Количество КАК Quantity,
	|	втКорректмровки.КоличествоУпаковок КАК QuantityUp,
	|	втКорректмровки.НомерСтроки
	|ИЗ
	|	втКорректмровки КАК втКорректмровки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДНомен
	|		ПО втКорректмровки.Номенклатура = ИДНомен.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДУпаковки
	|		ПО втКорректмровки.Упаковка = ИДУпаковки.Объект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ИДНомен.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК NomenclatureID,
	|	ЕСТЬNULL(ИДУпаковки.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК Upak,
	|	втВозврат.Количество КАК Quantity,
	|	втВозврат.КоличествоУпаковок КАК QuantityUp,
	|	втВозврат.НомерСтроки
	|ИЗ
	|	втВозврат КАК втВозврат
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДНомен
	|		ПО втВозврат.Номенклатура = ИДНомен.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДУпаковки
	|		ПО втВозврат.Упаковка = ИДУпаковки.Объект";
	Запрос.УстановитьПараметр("Ссылка", ОбъектОбработки.Ссылка);
	Запрос.УстановитьПараметр("ЗначениеСвойствоСтатуса", ЗначениеСвойствоСтатуса);
	Запрос.УстановитьПараметр("СвойствоСтатуса", СвойствоСтатуса);
	Запрос.УстановитьПараметр("СвойствоАкция", СвойствоАкция);
	Запрос.УстановитьПараметр("ЗначениеСвойствоСтатуса", ЗначениеСвойствоСтатуса);
	Запрос.УстановитьПараметр("ЗначениеСвойствоВыгружен", ЗначениеСвойствоВыгружен);
	
	Результат            = Запрос.ВыполнитьПакет();
	Выборка              = Результат[1].Выбрать();
	ВыборкаРаспоряжения  = Результат[3].Выбрать(); 	
	ВыборкаКорректировка = Результат[6].Выбрать();
	ВыборкаВозврт        = Результат[7].Выбрать();
	
	ФиксСтруктураКласса = "ID,Date,Number,ShipmentDirection,Description,PlanTime,Transport,Driver,Order,Update,Return";
	
	ФиксСтруктураРаспоряжения = "IDOrder, LineNumber";
	
	ФиксСтруктураВозвраты = "NomenclatureID,Quantity,QuantityUp,Upak,LineNum";  
	
	Если НЕ Результат[1].Пустой() Тогда
	
		Если Выборка.Следующий() тогда
			СтруктураДанных = Новый Структура(ФиксСтруктураКласса);		
			ЗаполнитьЗначенияСвойств(СтруктураДанных, Выборка);
			
			Если Выборка.Корректировка Тогда 
				  РезультатОбработки.ClassId = 31;		
			Иначе 
				  РезультатОбработки.ClassId = 28;   	
			КонецЕсли;
			
			Order = Новый Массив;		
			Пока ВыборкаРаспоряжения.Следующий() Цикл			
				СтруктураДанныхРаспоряжения = Новый Структура(ФиксСтруктураРаспоряжения);
				ЗаполнитьЗначенияСвойств(СтруктураДанныхРаспоряжения, ВыборкаРаспоряжения);
				Order.Добавить(СтруктураДанныхРаспоряжения);
			КонецЦикла;	
			СтруктураДанных["Order"] = Order;  
			
			Update_Массив = Новый Массив;		
			Пока ВыборкаКорректировка.Следующий() Цикл			
				СтруктураДанныхВозвраты = Новый Структура(ФиксСтруктураВозвраты);
				ЗаполнитьЗначенияСвойств(СтруктураДанныхВозвраты, ВыборкаКорректировка);
				Update_Массив.Добавить(СтруктураДанныхВозвраты);
			КонецЦикла;	
			СтруктураДанных["Update"] = Update_Массив;
			
			Return_Массив = Новый Массив;		
			Пока ВыборкаВозврт.Следующий() Цикл			
				СтруктураДанныхВозвраты = Новый Структура(ФиксСтруктураВозвраты);
				ЗаполнитьЗначенияСвойств(СтруктураДанныхВозвраты, ВыборкаВозврт);
				Return_Массив.Добавить(СтруктураДанныхВозвраты);
			КонецЦикла;	
			СтруктураДанных["Return"] = Return_Массив;
			
			РезультатОбработки.Body = сшпОбщегоНазначения.ПреобразоватьСтруктуруПоФормату(Перечисления.сшпФорматыСообщений.XML, СтруктураДанных);		
			//ВРЕМ
			РезультатОбработки.Receivers.Добавить("wms_prod");	
			//РезультатОбработки.Receivers.Добавить("WMS_test");
			
			//Записать доп свойство			
			ЗаданиеНаПеревозку = ОбъектОбработки.Ссылка.ПолучитьОбъект();
			СтрСвойство = ЗаданиеНаПеревозку.ДополнительныеРеквизиты.Найти(СвойствоСтатуса, "Свойство");
			Если СтрСвойство = Неопределено Тогда 
				НоваяСтр = ЗаданиеНаПеревозку.ДополнительныеРеквизиты.Добавить();
				НоваяСтр.Свойство = СвойствоСтатуса;
				НоваяСтр.Значение = ЗначениеСвойствоВыгружен;
			Иначе 
				СтрСвойство.Значение = ЗначениеСвойствоВыгружен;	
			КонецЕсли;    			
			ЗаданиеНаПеревозку.ДополнительныеСвойства.Вставить("НеРегистрироватьДляОбмена");
			ЗаданиеНаПеревозку.ДополнительныеСвойства.Вставить("СШПНеобрабатывать");    			
			ЗаданиеНаПеревозку.Записать();
			
		Иначе
			СостояниеСообщения = Перечисления.сшпСтатусыСообщений.ОбработкаОтменена;		
		КонецЕсли; 		
		
		
	Иначе 
		СостояниеСообщения = Перечисления.сшпСтатусыСообщений.ОтправкаОтменена;	
	КонецЕсли;

