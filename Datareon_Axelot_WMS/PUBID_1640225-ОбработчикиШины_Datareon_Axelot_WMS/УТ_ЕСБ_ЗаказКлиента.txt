    РезультатОбработки.ClassId = 22;
  	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ИДДок.Идентификатор КАК ID,
	|	ЗаказКлиента.Ссылка КАК Ссылка,
	|	ЗаказКлиента.ПометкаУдаления КАК IsMarked,
	|	ЗаказКлиента.Дата КАК Date,
	|	ЗаказКлиента.Номер КАК Number,
	// 31337 12.08.2019 начало блока
	|   ЗаказКлиента.Статус КАК Status,
	// 31337 12.08.2019 конец блока
	|	""ОтгрузкаКлиенту"" КАК Source,
	|	ЗаказКлиента.Комментарий КАК Description,
	|	ЕСТЬNULL(ИДКонтрагент.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК CounterpartyID,
	|	ЗаказКлиента.ДатаОтгрузки КАК ExpectedDate,
	|	ЕСТЬNULL(ИДОрганизации.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК OrganizationID,
	|	ЗаказКлиента.Статус КАК Статус
	|ПОМЕСТИТЬ втДокументы
	|ИЗ
	|	Документ.ЗаказКлиента КАК ЗаказКлиента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДДок
	|		ПО ЗаказКлиента.Ссылка = ИДДок.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДКонтрагент
	|		ПО ЗаказКлиента.Контрагент = ИДКонтрагент.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДОрганизации
	|		ПО ЗаказКлиента.Организация = ИДОрганизации.Объект
	|ГДЕ
	|	ЗаказКлиента.Ссылка = &Ссылка
	|	И ЗаказКлиента.Статус В(&Статус)
	|	И ЗаказКлиента.Проведен
	|	И НЕ ЗаказКлиента.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втДокументы.ID КАК ID,
	|	втДокументы.Ссылка КАК Ссылка,
	|	втДокументы.IsMarked КАК IsMarked,
	|	втДокументы.Date КАК Date,
	|	втДокументы.Number КАК Number,
	|	втДокументы.Source КАК Source,
	|	втДокументы.Description КАК Description,
	|	втДокументы.CounterpartyID КАК CounterpartyID,
	|	втДокументы.ExpectedDate КАК ExpectedDate,
	|	втДокументы.Status КАК Status,	
	|	втДокументы.OrganizationID КАК OrganizationID
	|ИЗ
	|	втДокументы КАК втДокументы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ЗаказКлиентаТовары.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА НоменклатураДополнительныеРеквизиты.Значение
	|		ИНАЧЕ ЗаказКлиентаТовары.Номенклатура
	|	КОНЕЦ КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА ЗаказКлиентаТовары.Номенклатура.Авэкс_АкционныйТовар
	|			ТОГДА ВЫРАЗИТЬ(НоменклатураДополнительныеРеквизиты.Значение КАК Справочник.Номенклатура).ЕдиницаИзмерения
	|		ИНАЧЕ ЗаказКлиентаТовары.Упаковка
	|	КОНЕЦ КАК Упаковка,
	|	ЗаказКлиентаТовары.КоличествоУпаковок КАК КоличествоУпаковок,
	|	ЗаказКлиентаТовары.НомерСтроки КАК НомерСтроки,
	|	ЗаказКлиентаТовары.Количество КАК Количество
	|ПОМЕСТИТЬ втТовары
	|ИЗ
	|	Документ.ЗаказКлиента.Товары КАК ЗаказКлиентаТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|		ПО ЗаказКлиентаТовары.Номенклатура = НоменклатураДополнительныеРеквизиты.Ссылка
	|			И (НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоАкция)
	|ГДЕ
	|	ЗаказКлиентаТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				втДокументы.Ссылка
	|			ИЗ
	|				втДокументы КАК втДокументы)
	|	И ЗаказКлиентаТовары.ВариантОбеспечения = ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.Отгрузить)
	|	И НЕ ЗаказКлиентаТовары.Отменено
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ИДНомен.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК NomenclatureID,
	|	втТовары.Количество КАК Quantity,
	|	втТовары.КоличествоУпаковок КАК QuantityUp,
	|	ЕСТЬNULL(ИДУпаковки.Идентификатор, ""00000000-0000-0000-0000-000000000000"") КАК Upak,
	|	втТовары.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	втТовары КАК втТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДНомен
	|		ПО втТовары.Номенклатура = ИДНомен.Объект
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упИдентификаторыОбмена КАК ИДУпаковки
	|		ПО втТовары.Упаковка = ИДУпаковки.Объект";  

	// 31337 12.08.2019 начало блока выгрузка заказов со статусом к отгрузке, отменен
	МассивСтатусов = Новый Массив;
	МассивСтатусов.Добавить(Перечисления.СтатусыЗаказовКлиентов.КОтгрузке);
	МассивСтатусов.Добавить(Перечисления.СтатусыЗаказовКлиентов.Отменен);
	МассивСтатусов.Добавить(Перечисления.СтатусыЗаказовКлиентов.КОбеспечению);
	
	
	Запрос.УстановитьПараметр("Статус", МассивСтатусов);
	// 31337 12.08.2019 начало блока выгрузка заказов со статусом к отгрузке, отменен
	
	Запрос.УстановитьПараметр("Ссылка",   ОбъектОбработки.Ссылка); 	
	
	Запрос.УстановитьПараметр("СвойствоАкция",  ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию("Прототип Акции", Ложь));
	
	Результат = Запрос.ВыполнитьПакет();
	Выборка   = Результат[1].Выбрать();
	ВыборкаРаспоряжения = Результат[3].Выбрать();

	
	ФиксСтруктураКласса = "ID,Date,Number,IsMarked,Source,OrganizationID,CounterpartyID,Description,ExpectedDate,GoodsLine,Status";
	
	ФиксСтруктураРаспоряжения = "NomenclatureID,Quantity,QuantityUp,Upak,LineNum";
	
	Если Выборка.Следующий() тогда
		
	//	Попытка
		//	НачатьТранзакцию();	
		//	БлокировкаДанных = Новый БлокировкаДанных;
		//	ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЗаказКлиента");
		//	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
		//	ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
		//	БлокировкаДанных.Заблокировать();
		//	ЗафиксироватьТранзакцию();
	//	Исключение	
			//Если ТранзакцияАктивна() Тогда 
		//		ОтменитьТранзакцию();
			//КонецЕсли;
			//СостояниеСообщения = Перечисления.сшпСтатусыСообщений.ОжиданиеОбработки;				
	//	КонецПопытки;
		
		Если СостояниеСообщения <>  Перечисления.сшпСтатусыСообщений.ОжиданиеОбработки Тогда  	
		
			СтруктураДанных = Новый Структура(ФиксСтруктураКласса);		
			ЗаполнитьЗначенияСвойств(СтруктураДанных, Выборка);
			
			// 31337 12.08.2019 начало блока
			Если Выборка.Status = Перечисления.СтатусыЗаказовКлиентов.КОтгрузке Или 
				 Выборка.Status = Перечисления.СтатусыЗаказовКлиентов.КОбеспечению Тогда
				СтруктураДанных.Status = "КОтгрузке";
			Иначе
				СтруктураДанных.Status = "Отменен";
			КонецЕсли;	
			// 31337 12.08.2019 конец блока
			
			GoodsLine = Новый Массив;		
			Пока ВыборкаРаспоряжения.Следующий() Цикл			
				СтруктураДанныхРаспоряжения = Новый Структура(ФиксСтруктураРаспоряжения);
				ЗаполнитьЗначенияСвойств(СтруктураДанныхРаспоряжения, ВыборкаРаспоряжения);
				GoodsLine.Добавить(СтруктураДанныхРаспоряжения);
			КонецЦикла;	
			СтруктураДанных["GoodsLine"] = GoodsLine;
			
			РезультатОбработки.Body = сшпОбщегоНазначения.ПреобразоватьСтруктуруПоФормату(Перечисления.сшпФорматыСообщений.XML, СтруктураДанных);
			
	
				//ВРЕМ
		РезультатОбработки.Receivers.Добавить("wms_prod");	
		//РезультатОбработки.Receivers.Добавить("WMS_test");
					
			
			
		КонецЕсли;
		
	Иначе
		СостояниеСообщения = Перечисления.сшпСтатусыСообщений.ОбработкаОтменена;		
	КонецЕсли;
